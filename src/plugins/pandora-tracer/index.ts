import { TW } from "@/utils/tailwindMixin";
import { LitElement, html } from "lit";
import { customElement, state } from "lit/decorators.js";

const TwLitElement = TW(LitElement);

@customElement("pandora-tracer")
export class ErrorCounter extends TwLitElement {
  @state()
  private count = 0;

  private originalConsoleError = console.error;

  constructor() {
    super();
    this.overrideConsoleError();
    this.attachGlobalListeners();
  }

  private overrideConsoleError() {
    console.error = (...args: any[]) => {
      this.incrementCount();
      this.originalConsoleError.apply(console, args);
    };
  }

  private attachGlobalListeners() {
    window.addEventListener("error", () => this.incrementCount());
    window.addEventListener("unhandledrejection", () => this.incrementCount());
  }

  private incrementCount() {
    this.count += 1;
    document.dispatchEvent(
      new CustomEvent("pandora::update-plugin-icon", {
        detail: {
          id: "pandora-tracer",
          icon: `<span>${this.count}</span>`,
        },
        bubbles: !0,
      })
    );
  }

  protected render() {
    return html`<div class="counter">Console Errors: ${this.count}</div>`;
  }
}

// Register the plugin directly using the static method
customElements.whenDefined("pandora-box").then(() => {
  (customElements.get("pandora-box") as any).registerPlugin({
    id: "pandora-tracer",
    label: "Tracer",
    component: "pandora-tracer",
    icon: `<svg viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.98057 3.51791C6.39094 3.51791 5.81456 3.69275 5.3243 4.02033C4.83404 4.34792 4.45193 4.81352 4.22629 5.35827C4.00064 5.90301 3.94161 6.50244 4.05664 7.08074C4.17167 7.65904 4.4556 8.19024 4.87253 8.60717C5.28946 9.0241 5.82067 9.30804 6.39897 9.42307C6.97727 9.5381 7.57669 9.47906 8.12144 9.25342C8.66619 9.02778 9.13179 8.64567 9.45937 8.15541C9.78695 7.66515 9.9618 7.08876 9.9618 6.49913C9.96097 5.70871 9.64662 4.9509 9.08771 4.392C8.5288 3.83309 7.77099 3.51873 6.98057 3.51791ZM6.98057 8.48661C6.58749 8.48661 6.20323 8.37005 5.87639 8.15166C5.54955 7.93327 5.29481 7.62287 5.14438 7.25971C4.99395 6.89654 4.9546 6.49692 5.03128 6.11139C5.10797 5.72586 5.29726 5.37172 5.57521 5.09377C5.85317 4.81581 6.2073 4.62652 6.59284 4.54984C6.97837 4.47315 7.37799 4.51251 7.74115 4.66294C8.10431 4.81336 8.41472 5.0681 8.6331 5.39494C8.85149 5.72178 8.96806 6.10604 8.96806 6.49913C8.96806 7.02624 8.75866 7.53176 8.38594 7.90449C8.01321 8.27722 7.50769 8.48661 6.98057 8.48661ZM12.4461 6.63328C12.4486 6.54385 12.4486 6.45441 12.4461 6.36497L13.3728 5.20727C13.4214 5.14648 13.455 5.07513 13.471 4.99897C13.487 4.92281 13.4848 4.84396 13.4647 4.76878C13.3128 4.19775 13.0856 3.64949 12.789 3.13842C12.7502 3.07154 12.6962 3.01465 12.6315 2.97228C12.5669 2.9299 12.4932 2.90321 12.4163 2.89434L10.9431 2.73037C10.8818 2.66578 10.8197 2.60367 10.7568 2.54404L10.5829 1.0671C10.5739 0.990213 10.5472 0.916483 10.5047 0.851784C10.4622 0.787085 10.4052 0.733206 10.3382 0.694443C9.82692 0.3984 9.2787 0.171384 8.70782 0.0193209C8.63259 -0.00068005 8.55371 -0.00272573 8.47755 0.0133487C8.40139 0.0294231 8.33006 0.0631679 8.26933 0.111863L7.11473 1.03356C7.02529 1.03356 6.93586 1.03356 6.84642 1.03356L5.68871 0.108758C5.62793 0.0601688 5.55658 0.0265366 5.48042 0.0105705C5.40425 -0.00539564 5.32541 -0.0032494 5.25022 0.0168365C4.67929 0.16902 4.13106 0.396249 3.61987 0.69258C3.55299 0.731414 3.4961 0.785324 3.45372 0.850019C3.41135 0.914713 3.38466 0.988406 3.37578 1.06523L3.21181 2.54094C3.14722 2.60263 3.08511 2.66474 3.02549 2.72726L1.54854 2.89682C1.47166 2.90577 1.39793 2.93255 1.33323 2.97503C1.26853 3.01752 1.21465 3.07453 1.17589 3.14153C0.879845 3.65279 0.65283 4.20101 0.500766 4.77188C0.480765 4.84711 0.47872 4.92599 0.494794 5.00215C0.510868 5.07832 0.544613 5.14964 0.593308 5.21037L1.515 6.36497C1.515 6.45441 1.515 6.54385 1.515 6.63328L0.590203 7.79099C0.541614 7.85178 0.507982 7.92312 0.492016 7.99929C0.47605 8.07545 0.478196 8.1543 0.498282 8.22948C0.650193 8.80051 0.877437 9.34877 1.17403 9.85983C1.21286 9.92671 1.26677 9.98361 1.33146 10.026C1.39616 10.0684 1.46985 10.095 1.54668 10.1039L3.0199 10.2679C3.08159 10.3325 3.1437 10.3946 3.20622 10.4542L3.37827 11.9312C3.38721 12.008 3.41399 12.0818 3.45648 12.1465C3.49896 12.2112 3.55598 12.2651 3.62297 12.3038C4.13423 12.5999 4.68245 12.8269 5.25333 12.9789C5.32856 12.9989 5.40743 13.001 5.4836 12.9849C5.55976 12.9688 5.63109 12.9351 5.69182 12.8864L6.84642 11.9647C6.93586 11.9672 7.02529 11.9672 7.11473 11.9647L8.27244 12.8914C8.33322 12.94 8.40457 12.9736 8.48073 12.9896C8.5569 13.0055 8.63574 13.0034 8.71093 12.9833C9.28195 12.8314 9.83022 12.6041 10.3413 12.3075C10.4082 12.2687 10.4651 12.2148 10.5074 12.1501C10.5498 12.0854 10.5765 12.0117 10.5854 11.9349L10.7493 10.4617C10.8139 10.4004 10.876 10.3383 10.9357 10.2753L12.4126 10.1014C12.4895 10.0925 12.5632 10.0657 12.6279 10.0232C12.6926 9.98074 12.7465 9.92373 12.7853 9.85673C13.0813 9.34547 13.3083 8.79725 13.4604 8.22637C13.4804 8.15114 13.4824 8.07227 13.4664 7.9961C13.4503 7.91994 13.4165 7.84862 13.3678 7.78789L12.4461 6.63328ZM11.4462 6.22958C11.4568 6.40912 11.4568 6.58913 11.4462 6.76868C11.4388 6.89161 11.4773 7.0129 11.5543 7.10904L12.4356 8.21023C12.3345 8.53162 12.205 8.84339 12.0487 9.14186L10.645 9.30086C10.5228 9.31443 10.4099 9.37285 10.3282 9.46482C10.2087 9.59928 10.0813 9.72662 9.94689 9.84617C9.85491 9.92782 9.79649 10.0407 9.78292 10.1629L9.62703 11.5653C9.3286 11.7217 9.01682 11.8512 8.6954 11.9523L7.59359 11.071C7.50542 11.0005 7.3959 10.9622 7.28304 10.9623H7.25323C7.07369 10.9728 6.89367 10.9728 6.71413 10.9623C6.5912 10.9549 6.46991 10.9934 6.37377 11.0703L5.26948 11.9523C4.94809 11.8512 4.63632 11.7217 4.33785 11.5653L4.17885 10.1635C4.16528 10.0413 4.10686 9.92844 4.01488 9.84679C3.88042 9.72724 3.75309 9.5999 3.63353 9.46544C3.55188 9.37347 3.43902 9.31505 3.31678 9.30148L1.91436 9.14496C1.75797 8.84653 1.62848 8.53475 1.52742 8.21333L2.40875 7.11152C2.4857 7.01538 2.52422 6.89409 2.51682 6.77117C2.50626 6.59162 2.50626 6.41161 2.51682 6.23206C2.52422 6.10914 2.4857 5.98785 2.40875 5.89171L1.52742 4.78803C1.62855 4.46664 1.75804 4.15487 1.91436 3.8564L3.31616 3.6974C3.4384 3.68383 3.55126 3.62541 3.63291 3.53344C3.75247 3.39898 3.8798 3.27164 4.01426 3.15209C4.1066 3.07038 4.16526 2.95726 4.17885 2.83471L4.33474 1.43292C4.63318 1.27652 4.94495 1.14703 5.26637 1.04598L6.36818 1.9273C6.46432 2.00426 6.58561 2.04277 6.70854 2.03537C6.88808 2.02481 7.0681 2.02481 7.24764 2.03537C7.37057 2.04277 7.49186 2.00426 7.588 1.9273L8.69167 1.04598C9.01306 1.14711 9.32483 1.2766 9.6233 1.43292L9.7823 2.83471C9.79587 2.95695 9.85429 3.06981 9.94627 3.15147C10.0807 3.27102 10.2081 3.39835 10.3276 3.53281C10.4093 3.62479 10.5221 3.68321 10.6444 3.69678L12.0468 3.85267C12.2032 4.15111 12.3327 4.46289 12.4337 4.78431L11.5524 5.88612C11.4747 5.98307 11.4361 6.10561 11.4443 6.22958H11.4462Z" fill="currentColor"/></svg>`,
  });
});
